[[background]]

==  第１章　全体構成

eVはかわさきロボット競技大会(通称かわロボ)の特にバトルロボット部門への参加機体（通称かわロボ）となります。
そのためシステム構成は大会ルールに適合するように設計されており、全体構成を説明するまえにまず簡単に大会について
簡単に説明します。

=== かわロボ

バトルロボット部門ではフィールド (<<ch1_kawa_field>>) 上の２つの機体が戦います。
ルールは比較的単純でフィールド外に相手の機体を押し出すかフィールド上で移動不能な状態にすることで勝利が確定します
(footnote:[後者の場合は制約条件があったり、他の勝利条件もありますがここでは詳細を省きます。])。
基本的に機体の操作は製作者による遠隔操縦にて行います。
自律動作を禁止されているわけではありませんが、採用した機体はほぼ見かけません。
参加機体にはサイズや重量、通信方式、動力源、機構的及び運動的制約が課されます。

[[ch1_kawa_field]]
.かわロボフィールド
image::kawa_field/ring_assys.png[width="400", align="center"]

=== メカハードウェア

前書 <<ref2>> にてすでにeVのメカハードウェア構成についてすでに説明しているので詳細についてはそちらに譲りますが、
簡単に説明したいと思います。
eVのメカ全体構成図および表を以下に再掲します。

[[ch1_spec]]
.eV　全体構成
image::./eV_basic_design/spec.png[width="420", align="center"]

==== 機構構成とサイズ

かわさきロボット競技大会のバトルロボット部門 <<ref3>> のルールでは
すくなくとも１つの腕機構と脚機構（および補助機構）とにより構成されていることを要求しています。
さらに腕機構は（詳細は省きますが、）揺動運動を行う閉リンク機構により実現されなければなりません。
四脚歩行ロボットそのものには腕機構は必要は無いのですが、規定に準拠するために首および顔の咀嚼機構を便宜的に腕機構としています。
また転倒復帰のための補助機構等として尻尾や首が装備されており、機体の大きさについても250[mm] x 350[mm] x 700[mm]
（試合開始時）という規定を満たすように設計しています。
<<ch1_spec>> のように首や尻尾を伸ばした状態ではサイズオーバーとなるため試合開始時はこれらを折りたたんで亀状態になります。

==== 動力源の構成と重量

一般に小型のロボットの動力源には電磁アクチュエータが多く利用されます。
かわロボもこの例にもれず、主たるアクチュエータとしてマブチモータ製のRS-380PH <<ref4>> もしくはその互換品が指定されています。
RS-380PH以外の電磁モータとしては、ラジオ・コントロールカー（RCカー）やホビーロボットに多用されるサーボモータも利用することができます。
サーボモータに関しては、無限回転制御できる状態で使用してはならないなどの制約はあるものの、製品指定が無いため選択肢が広くなっています。
一方、多脚ロボットでまともな歩行制御を行おうとした場合多くのアクチュエータが必要となります。
たとえば四脚ロボットで各脚をシリアルリンク機構で構成して、脚先と地面との接触位置とを制御しようとした場合には12個のアクチュエータが必要となります。かわロボの場合腕機構も必要となるため実際にはこれより多いアクチュエータが必要になります。
実際eVでは1脚あたり4自由度で補助機構なども含めると全19自由度です。
これらすべてをRS-380PH（80[g]）で構成した場合にはアクチュエータだけで1520[g]もの重量になります。
それぞれに減速機を設けるとするとそれだけで3000[g]近くになってしまいます。
かわロボでは全重量を3300[g]に収めなければならないため、これでは構造部材やバッテリなどのための重量を確保することができません。
そのためより小型軽量なサーボモータを採用しています。
この結果構造部材や制御基板等も含めてeVの総重量は3250[g]になります。

<<<

=== 電気ハードウェア

==== 要求仕様

かわロボの規則により規定されているのは機械的な仕様ばかりではありません。
以下のような電気的な要求事項があります。

1. 機体との通信には双葉電子工業が製造するRC製品向けのプロポおよび受信機を使用すること

1. 機体総重量の制約（3300g）があること

1. バッテリはNiMH,NiCd,LiFeなどの過放電を行っても安定なものを使用すること

最後の仕様は特に制約事項となるものではありませんが、
前者の２つはハードウェアの設計に大きく影響します。

==== 通信仕様

RC製品向けのプロポ(<<ch1_propo>>)とは送信機とコントローラが一体となったものです。
機体側が送信機と通信するためには専用の受信機(<<ch1_recv>>)が必要になります。

[[ch1_propo]]
.双葉電子製プロポ 10J footnote:[https://rc.futaba.co.jp/propo/air/img/10j/img_01.jpg]
image::./chapter1/propo.jpg[width="120", align="center"]

[[ch1_recv]]
.双葉電子製受信機 R3008SB footnote:[http://rc.futaba.co.jp/reciever/air04/img/r3008sb.jpg]
image::./chapter1/r3008sb.jpg[width="80", align="center"]

左右のジョイスティックを傾斜させた量が送信機から受信機、そしてモータアンプに伝わり、
モータアンプがアクチュエータの回転速度を変化させることで機体を動作させます。
サーボモータの場合には傾斜量は回転速度ではなく回転角度に変換されてサーボモータの出力軸の角度が制御されます。
どちらの場合も、ジョイスティックの傾斜量がそのままアクチュエータ（モータ）の動作に反映されます。
プロポ操作者の指先加減一つでアクチュエータごとの速度や位置を調整することができるのである意味操作者の意図通りに動かすことができます。
しかし、多脚ロボットを制御する場合にはすべての脚を正確かつ強調してこまやかに制御する必要があります。
これにはプロポ操作量（傾斜量）を単純に読み替えてアクチュエータに伝える方法は向きません。
単純にプロポのスティック数が４つしか無く、そのままでは４自由度分しか操作できないということもあります。
とにかく、多脚ロボットにおいては受信機がモータアンプやサーボモータと通信する信号を
正確に読み取り、適切な意味付けを行って多数あるアクチュエータを強調して制御する必要があります。
受信機が出す信号の把握が肝要ということです。

==== 受信機通信仕様

双葉電子工業製の受信機だけに限らず、多くのRC製品向けの受信機ではPPM footnote:[Pulse Position Modulation の略語]という
信号を採用しています。
PPMの信号では一定期間ごとに出力（送出）される矩形波の立ち下がりの時間的位置を操作量として伝達します。
RC製品向けのPPMでは<<ch1_ppms>>のように、おおよそ20[msec]毎に送出されます footnote:[メーカなどにより違いがあります]。
矩形部分の詳細を<<ch1_ppm>>に示します。
プロポのスティックが操作されていない時（ニュートラルポジションの時）には信号の立ち上がり時刻と立ち下がり時刻との差は1500usec
ですが、スティックの操作量に応じておおよそ1000〜2000usecの間に収まる形で変化します footnote:[こちらもメーカなどにより違いがあります]。
プロポや受信機にもよりますが、最低でもスティック数分である4ch分のPPM信号が受信機から送出されるので、
これを取りこぼしなく正確に受信・解釈できるシステムが必要となります。

[[ch1_ppms]]
.RC PPM信号周期
image::./chapter1/ppms.png[width="400", align="center"]

[[ch1_ppm]]
.RC プロポ操作とPPM信号
image::./chapter1/ppm.png[width="400", align="center"]

<<<

[NOTE]
====
受信機が送出する信号をPPMではなくPWM (Pulse Width Modulation)と表現している例がありますが、
PWMとは矩形波の山と谷の比率を調節して見かけ上の電圧値を変化させるために使用する変調方式です。
PPMのものと同一の信号波をPWMで生成することはできますが、信号の立ち下がりの時間的位置を伝達する
PPMとは本質的には異なります。
====

[NOTE]
====
最近はPPMではなく他の通信プロトコルを採用する製品もあります。
例えば、双葉電子工業製の製品ではS.BUSやS.BUS2といった規格がそれに当たります。
これを利用することもできるのですが、S.BUS系の通信仕様は正式には公開されていないため、
自分で仕様を解析する必要があります。
草の根的に仕様を解析する活動もあるのですが、あまり活発ではありません。
筆者も軽く調べてみたところ、
基本的な仕様はすぐに推測できるものの安定した通信を行うためには
網羅的な仕様の把握が必要そうな割に双方向通信ができるようになるわけでもなく、
メリットが少ないということがわかりました。
頑張ればできるのでしょうが労力に見合わないと考えています。
====

<<<

==== 求められる演算能力

ここで多脚ロボット別の側面に視野を向けてみましょう。
多脚ロボットでは地面や対戦相手等からの外力を受けつつ、転ばずに姿勢制御や移動を実現します。
これにはリアルタイムかつ適応的に脚先の軌道を生成する必要があり、
脚先の位置・姿勢からアクチュエータの駆動量を求める干渉回避付き逆運動学演算などを行わなければなりません。
このような演算はかわロボでの仕様例も多いワンチップマイコンなどでは実力不足です。
さらに、環境認識や軌道計画といった高度な問題設定をも行おうとした場合にはより高い演算能力が求められます。
このような問題に適用されるアルゴリズムは通常Intel Coreシリーズのようなある程度高スペックなCPUなどを用いて行われます。
これらを踏まえるとできるだけ高スペックな演算能力をもつデバイス（CPU）を使用する必要があると言えます。

[NOTE]
====
巷で流行りのミドルウェアであるROS（Robot Operating System）の導入なども考えると、
Linuxが動作する様なある程度リッチな環境がほしいところです。
より組み込み機器に合致するであろうROS2等を試してみるというのも考えられますが、
こちらはまだ黎明期ですのでリスクが大きくなります。
またROSとの純粋な互換性がなくエコシステムの旨味も得られません。
====

==== 演算デバイス選定

本章のこれまでの議論により
eVの電気ハードウェアには以下のことが求められていると言えます。

- RC製品向けのPPM信号を取りこぼしなく正確に受信処理できること(ハードリアルタイム性）

- 多脚ロボット向けの高度なアルゴリズムを高速にで実行可能なこと

機体総重量の大部分を機構部品特にアクチュエータが占めざるをえないことを踏まえてると
小型のシングルボードコンピュータ（SBC）を使用するのが理にかなった選択であると言えます。
あくまでも趣味の活動ですので、入手性（ネット通販や秋葉原で簡単かつ即時に購入可能）やコスト（10000円以下）
、情報の入手性（ネット上から必要な情報が十分に手に入ること）を念頭に置くと、以下のようなボードが選択肢としてあがります。

1. Raspberry Pi シリーズ

1. Arduino シリーズ

1. BeagleBone シリーズ

まずRaspberry Pi (以下ラズパイ）ですが、これはハードリアルタイム性能が大きく欠如しています。
Linuxをベースとした標準的なラズパイ環境では1000〜2000 usecで変化するPPM信号を正確に捉えることはできません。
実際に試してみましたが全くと行っていいほど使い物になりませんでした。
次にArduinoですがこれは演算性能が足りません。標準的なArduinoが採用するCPUがAtmegaであることを考えるとこれは自明です。
このCPUはラズパイなどで使用されるARM系CPUと比べると１０分の１以下の動作周波数しかありません。
BeagleBoneシリーズですが、BeagleBoneBlack（以下BBB)にはある程度高性能なARM系CPUが採用されています。
ここはラズパイと同様ですが、BBBが採用しているTI（テキサス・インストゥルメンツ）製のチップには
Programmable Realtime Unit (PRU)と呼ばれるコプロセッサが搭載されています。
このPRUはその名の通りユーザが専用のプログラムを生成することができるようになっていまくエコシステムの旨味も得られません。
以上を踏まえて、eVではBBBを中心としたシステムを設計することとしました。

[IMPORTANT]
====
PRUはCPUとしてみるとかなり特殊な仕様を持ちます、
動作周波数が200MHｚと高いリアルタイム性を持つチップとしては高い周波数を持つ一方で
除算命令が無いなどあまり見ない命令セットを持ちます。
高級言語（C言語）による開発環境も提供されていますが、
PRU独特の命令セットの特性上、非効率的な実行コードが生成されやすくなっていると考えられます。
除算処理を期待したコードの多用は避けるなどの工夫が求められていると言えます。
====

==  第２章　電気ハードウェアの設計と実装

本章では最終的にeVに搭載したBBBによる制御システムハードウェアの設計図(回路図）
と実装図（実体配線図）の解説を行います。

=== 設計

BBBをは非常に多機能なSBC(Single Board Computer) <<ref5>> ですが、それでも今回の使用用途にそのまま使用することはできません
(例えば、コネクタ形状の不一致など）。
そのため <<ch2_ev_design>> のように自前のドーターボードを作成することで足りない機能を補うことにしました。
具体的なドーターボードの役割は次の次項にて説明します。

[[ch2_ev_design]]
.ev制御ボード外観 footnote:[BBB画像は http://beagleboard.org/static/images/black_hardware_details.png より]
image::chapter2/ev_bbb_assy.png[width="33%", align="center"]

<<<

==== 回路図

次ページにevの制御ボードの回路図を示します。
回路は主に３つのブロックからなります。
各ブロックと役割を以下に示します

===== ブロック１：電源部

回路図の *左上* 部分になります。

- バッテリとの接続

- バッテリ電圧の降圧

- バッテリとサーボモータ間の中継

===== ブロック２：受信機側通信部

回路図の *右上* 部分になります。

- 受信機と制御基板との接続 footnote:[受信機のポート番号を明示するためのもので実際のドーターボードには反映されるわけではありません]

===== ブロック３：BBB側通信部

回路図の *下* 部分になります。

- BBBと受信機間の信号レベルの変換

- 受信機との接続


[[ch2_ev_sch]]
.ev制御ボードの回路図
image::kicad/eV.sch.svg2.png[width="85%", align="center"]

=== 回路図の詳細説明

==== 電源部

<<ch2_ev_sch_pow>> は電源部の拡大図です。
電源部ではバッテリからの配線 (BAT_VddとBAT_GNDと記載) を３端子レギュレータ（７８０５と記載）
に接続してBBB本体に電源供給 (+5Vと記載)を行っています。
また、バッテリの電源はコネクタ (P0 CONN_02X03 と記載）を経由してサーボモータに接続しています。
消費が大きいモータの駆動電力をバッテリから直接供給するためにこのような配線になっています。

[[ch2_ev_sch_pow]]
.電源部の拡大図
image::kicad/ev_sch_1_3_power.png[width="30%", align="center"]

==== 通信部

<<ch2_ev_sch_com>> は通信部の拡大図です。
BBBは電源供給部分を除くと外部との接続部分は3.3Vの電圧レベルで動作しています。
一方で前章で触れたとおり受信機の送出するPPM信号の電圧レベルは5.0Vです。
この差分を埋めるために境界部分で電圧を調整する必要があります。
具体的にはレベル変換ボードは電圧のリファレンスピン(VCCA, VCCB)から入力された電圧値に従って変換先／元の電圧を決定するため、
それぞれに3.3Vと5.0Vを入力しています。
さらにBBBと側のポート（P9の27,28,29,30,31,41,42)をロジックレベル変換ボード
の+3.3V側 (A0〜A6) に接続しています。一方で、受信機から来た配線(破線で囲まれたto_S3008SBと記載されている
PPM_1〜PPM_7)は+5.0V側 (B0〜B6) に接続しています。

[[ch2_ev_sch_com]]
.通信部の拡大図
image::kicad/eV_sch_3_3_bbb.png[width="26%", align="center"]

<<<

=== 実体配線図

以下にevの制御ボードの回路図を示します。
みやすさを考えて、背景を緑色にした図も合わせて示します。
緑色の線が基板の裏側の配線で、赤色の先は基板の表側での配線となっています。

[[ch2_ev_art]]
.ev制御ボードの実体配線図
image::kicad/eV-brd.svg.png[width="100%", align="center"]

[[ch2_ev_art_green]]
.ev制御ボードの実体配線図 (背景緑）
image::kicad/eV_brd_green.png[width="20%", align="center"]

//<<<
//
//==  第３章　ソフトウェアの実装
//
//[[ch3_pru_block]]
//.PRU footnote:[http://linuxgizmos.com/files/ti_cpu_pru_block-sm.jpg]
//image::chapter3/ti_cpu_pru_block.jpg[width="50%", align="center"]
//
//[source, shell]
//----
//> wget http://software-dl.ti.com/processor-sdk-linux/esd/AM335X/02_00_02_11/index_FDS.html
//----
//
